# 第20章 組織管理サービスの構築

> 本章では、Winyxプロジェクトを業務システムやSaaSへと発展させるための基盤となる、組織管理マイクロサービス（OrgService）の設計と構築について解説します。

---

## 第1節 OrgServiceのアーキテクチャと責務

### 20.1.1 サービスの目的と責務

`OrgService`は、Winyxプロジェクトにおけるマルチテナント機能の中核を担います。既存の`UserService`が「個人」の認証を管理するのに対し、`OrgService`は「組織」という概念を導入し、以下の責務を負います。

- **組織管理**: 組織のライフサイクル（作成、更新、削除）を管理します。
- **メンバーシップ管理**: どのユーザーがどの組織に所属しているかを管理します。
- **役割ベースのアクセス制御 (RBAC)**: 組織内での役割（Role）と権限（Permission）を定義・管理します。
- **招待管理**: 組織へのユーザー招待フローを管理します。

### 20.1.2 `UserService`との連携

`OrgService`は独立したマイクロサービスとして、独自のデータベース(`winyx_org`)を保有します。ユーザーの基本情報（名前、メールアドレスなど）は`UserService`が単一の情報源として管理し、`OrgService`はRPC経由でこれらの情報を参照します。これにより、データの一貫性を保ちつつ、サービス間の疎結合を実現します。

**連携アーキテクチャ:**
```
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│   Frontend      │◀───▶│   API Gateway   │◀───▶│   OrgService    │
│ (Next.js)       │ HTTP │ (Nginx)         │ HTTP │ (Port: 8890)    │
└─────────────────┘      └─────────────────┘      └──────┬──────────┘
                                                            │ RPC
                                                            ▼
                                                    ┌─────────────────┐
                                                    │   UserService   │
                                                    │ (ユーザー情報取得) │
                                                    └─────────────────┘
```

---

## 第2節 契約とデータベースの設計

契約駆動開発のアプローチに基づき、API契約とデータベーススキーマを最初に定義します。

### 20.2.1 データベーススキーマ (`winyx_org`)

組織、メンバー、役割、招待を管理するための新しいデータベース`winyx_org`を作成し、そのスキーマを定義します。

- [ ] **データベース作成スクリプトの更新**
    - `scripts/setup_database.sh` に `winyx_org` データベースを作成する処理を追加します。

- [ ] **OrgService用スキーマファイルの作成**
    - `/var/www/winyx/contracts/org_service/schema.sql` を作成します。

```sql
-- /var/www/winyx/contracts/org_service/schema.sql

-- 組織テーブル
CREATE TABLE IF NOT EXISTS orgs (
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    name        VARCHAR(100) NOT NULL COMMENT '組織名',
    owner_id    BIGINT NOT NULL COMMENT '組織の所有者 (users.id)',
    created_at  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at  TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_owner_id (owner_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 組織メンバーテーブル
CREATE TABLE IF NOT EXISTS org_members (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    org_id BIGINT NOT NULL,
    user_id         BIGINT NOT NULL,
    role_id         BIGINT NOT NULL,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (org_id) REFERENCES orgs(id) ON DELETE CASCADE,
    -- FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    UNIQUE KEY idx_org_user (org_id, user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 役割（ロール）テーブル
CREATE TABLE IF NOT EXISTS roles (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    org_id BIGINT NOT NULL,
    name            VARCHAR(50) NOT NULL COMMENT '役割名 (例: Admin, Member)',
    permissions     JSON NOT NULL COMMENT '権限リスト (例: ["member:invite", "org:update"])',
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (org_id) REFERENCES orgs(id) ON DELETE CASCADE,
    UNIQUE KEY idx_org_role_name (org_id, name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 招待管理テーブル
CREATE TABLE IF NOT EXISTS invitations (
    id              BIGINT AUTO_INCREMENT PRIMARY KEY,
    org_id BIGINT NOT NULL,
    email           VARCHAR(255) NOT NULL COMMENT '招待された人のメールアドレス',
    role_id         BIGINT NOT NULL,
    token           VARCHAR(100) NOT NULL UNIQUE,
    status          ENUM('pending', 'accepted', 'expired') NOT NULL DEFAULT 'pending',
    expires_at      TIMESTAMP NOT NULL,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (org_id) REFERENCES orgs(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 20.2.2 API契約 (`org.api`)

組織管理に必要なAPIエンドポイントを定義します。

- [ ] **OrgService用API契約ファイルの作成**
    - `/var/www/winyx/contracts/org_service/org.api` を作成します。

```go
// /var/www/winyx/contracts/org_service/org.api

syntax = "v1"

info(
    title: "Winyx Org Service API"
    desc: "組織、メンバーシップ、役割、招待を管理するマイクロサービス"
    author: "Winyx Team"
    version: "v1.0"
)

// ======== 型定義 ========

type User {
    Id    int64  `json:"id"`
    Name  string `json:"name"`
    Email string `json:"email"`
}

type Role {
    Id          int64    `json:"id"`
    Name        string   `json:"name"`
    Permissions []string `json:"permissions"`
}

type Member {
    UserId int64  `json:"user_id"`
    Name   string `json:"name"`
    Email  string `json:"email"`
    Role   string `json:"role"`
}

type Org {
    Id      int64  `json:"id"`
    Name    string `json:"name"`
    OwnerId int64  `json:"owner_id"`
}

type CreateOrgReq {
    Name string `json:"name" validate:"required,min=2,max=100"`
}

type InviteMemberReq {
    Email  string `json:"email" validate:"required,email"`
    RoleId int64  `json:"role_id" validate:"required"`
}

type AcceptInvitationReq {
    Token string `json:"token" validate:"required"`
}

type CommonRes {
    Success bool   `json:"success"`
    Message string `json:"message"`
}

// ======== APIエンドポイント定義 ========

@server(
    jwt: Auth
    prefix: /api/v1
)
service org-api {
    // 組織の作成
    @handler createOrg
    post /orgs (CreateOrgReq) returns (Org)

    // 所属する組織一覧の取得
    @handler listOrgs
    get /orgs returns ([]Org)

    // 招待の承諾
    @handler acceptInvitation
    post /invitations/accept (AcceptInvitationReq) returns (CommonRes)
}

@server(
    jwt: Auth
    middleware: OrgAuth // 組織への所属と権限をチェックするミドルウェア
    prefix: /api/v1/orgs/:orgId
)
service org-api {
    // 組織情報の取得
    @handler getOrg
    get / returns (Org)

    // メンバーの招待
    @handler inviteMember
    post /members/invite (InviteMemberReq) returns (CommonRes)

    // メンバー一覧の取得
    @handler listMembers
    get /members returns ([]Member)

    // 役割（ロール）一覧の取得
    @handler listRoles
    get /roles returns ([]Role)
}
```

---

## 第3節 バックエンド実装計画

### 20.3.1 Go-Zeroプロジェクト生成

1.  **プロジェクト雛形作成**
    ```bash
    cd /var/www/winyx/backend
    goctl api new org_service --style gozero
    ```
2.  **API契約からコード生成**
    ```bash
    cd org_service
    cp ../../contracts/org_service/org.api ./org.api
    goctl api go -api org.api -dir . --style gozero
    ```

### 20.3.2 設定とモデル生成

1.  **設定ファイル (`etc/org_service-api.yaml`) の作成**
    - `winyx_org` データベースへの接続情報を記述します。
    - `UserService` へのRPCクライアント設定を追加します。
2.  **データベース適用**
    - `setup_database.sh` を実行して `winyx_org` DBを作成します。
    - `mysql` コマンドで `schema.sql` を適用します。
3.  **モデル生成**
    ```bash
    goctl model mysql ddl -src ../../contracts/org_service/schema.sql -dir ./internal/model -c
    ```

### 20.3.3 ビジネスロジックの実装

-   **組織作成ロジック (`createorglogic.go`)**
    1.  `orgs` テーブルに新しい組織を登録します。
    2.  `roles` テーブルにデフォルトの役割（例: "Admin", "Member"）を作成します。
    3.  `org_members` テーブルに、作成者（Owner）を最初のメンバーとして登録します。

-   **メンバー招待ロジック (`invitememberlogic.go`)**
    1.  セキュアなランダム文字列で招待トークンを生成します。
    2.  `invitations` テーブルに招待情報を保存します（有効期限付き）。
    3.  **（将来）** `NotificationService` をRPCで呼び出し、招待メールの送信を依頼します。

-   **権限チェックミドルウェア (`orgauthmiddleware.go`)**
    1.  リクエストコンテキストから `userId` (JWT) と `orgId` (URLパス) を取得します。
    2.  `org_members` テーブルを検索し、ユーザーがその組織のメンバーであるかを確認します。
    3.  メンバーの役割 (`role_id`) を取得し、その役割が要求された操作を実行する権限 (`permissions`) を持っているか検証します。
    4.  権限がない場合は `403 Forbidden` エラーを返します。

---

## 第4節 フロントエンド統合計画

### 20.4.1 型定義とAPIクライアントの自動生成

1.  **同期スクリプトの設定更新**
    - `scripts/generate_frontend_types.js` の設定に `org.api` を追加します。
2.  **生成実行**
    - `sync_contracts.sh` を実行すると、`OrgService`用の型定義、APIクライアント、React Queryフックが `frontend/src/` 以下に自動生成されます。

### 20.4.2 UIコンポーネントの実装

自動生成された型とフックを利用して、以下のUIコンポーネントを構築します。

-   **組織作成ページ (`/orgs/new`)**
    -   `useCreateOrg` フックを利用したフォーム。
-   **組織切り替えドロップダウン**
    -   `useListOrgs` フックで取得した組織一覧を表示。
-   **メンバー管理ページ (`/orgs/:orgId/members`)**
    -   `useListMembers` フックでメンバー一覧を表示。
    -   `useInviteMember` フックを利用した招待モーダル。

---

## 第5節 運用とデプロイ

### 20.5.1 Nginx設定

-   `nginx_upstream.conf` に `org_service` のUpstreamを追加します。
    ```nginx
    upstream org_service {
        server 127.0.0.1:8890;
    }
    ```
-   `winyx.jp` の設定ファイルに `/api/v1/orgs` へのプロキシ設定を追加します。

### 20.5.2 systemdサービス

-   `org_service` をデーモン化するための `winyx-org-service.service` ファイルを作成します。
-   `UserService` の後に起動するように依存関係を設定します。

---

## 第6節 将来の展望

`OrgService` は、Winyxプロジェクトを本格的な業務システム・SaaSへ進化させるための強力な基盤となります。

-   **マルチテナントアーキテクチャ**: 各 `org` を独立した「テナント」として扱うことで、顧客ごとに完全に分離された環境を提供できます。
-   **監査ログ**: `OrgService` での操作（誰がメンバーを招待したか、誰が権限を変更したか）を記録する `AuditService` と連携できます。
-   **SSO連携**: 組織ごとにSAMLやOAuth2を利用したシングルサインオン（SSO）設定を可能にする基盤となります。
