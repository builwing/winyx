# ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæˆ¦ç•¥

> Winyxãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãŠã‘ã‚‹ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

---

## ğŸ—ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæˆ¦ç•¥

### ğŸ“Š **æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼šãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   winyx_core    â”‚    â”‚   winyx_task    â”‚    â”‚   winyx_mem     â”‚
â”‚   (å…±é€šãƒ»èªè¨¼)   â”‚    â”‚  (ã‚¿ã‚¹ã‚¯ç®¡ç†)    â”‚    â”‚ (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ users         â”‚    â”‚ â€¢ tasks         â”‚    â”‚ â€¢ messages      â”‚
â”‚ âœ“ sessions      â”‚    â”‚ â€¢ task_assign   â”‚    â”‚ â€¢ channels      â”‚
â”‚ âœ“ user_profiles â”‚    â”‚ â€¢ categories    â”‚    â”‚ â€¢ participants  â”‚
â”‚ â€¢ roles         â”‚    â”‚ â€¢ task_history  â”‚    â”‚ â€¢ attachments   â”‚
â”‚ â€¢ permissions   â”‚    â”‚ â€¢ comments      â”‚    â”‚ â€¢ message_read  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ†æ•£æˆ¦ç•¥

### 1. **winyx_coreï¼ˆå…±é€šåŸºç›¤ï¼‰** â­
```sql
-- æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãã®ã¾ã¾æ´»ç”¨ï¼‰
users (id, name, email, password, status, created_at, updated_at)
sessions (id, user_id, token, expires_at, created_at)  
user_profiles (id, user_id, avatar_url, bio, phone, address, birth_date, gender, occupation, website, social_links, preferences, created_at, updated_at)

-- æ¨©é™ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦è¿½åŠ ï¼‰
roles (id, name, description, created_at, updated_at)
permissions (id, name, resource, action, description, created_at, updated_at)
user_roles (id, user_id, role_id, created_at)
role_permissions (id, role_id, permission_id, created_at)
```

**è²¬ä»»ç¯„å›²ï¼š**
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒ»èªå¯
- âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†  
- âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç®¡ç†
- âœ… æ¨©é™ãƒ»å½¹å‰²ç®¡ç†

### 2. **winyx_taskï¼ˆã‚¿ã‚¹ã‚¯ç®¡ç†å°‚ç”¨ï¼‰** ğŸ“‹
```sql
CREATE DATABASE winyx_task;

-- ã‚¿ã‚¹ã‚¯é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«
tasks (
    id, user_id, title, description, status, priority, 
    due_date, created_at, updated_at
)

task_assignments (
    id, task_id, assigned_user_id, assigned_by, created_at
)

task_categories (
    id, name, color, description, created_at, updated_at
)

task_comments (
    id, task_id, user_id, content, created_at, updated_at
)

task_attachments (
    id, task_id, file_name, file_path, file_size, 
    mime_type, created_at
)

task_history (
    id, task_id, user_id, action, old_value, new_value, 
    created_at
)

task_labels (
    id, task_id, label_name, color, created_at
)

task_dependencies (
    id, task_id, depends_on_task_id, created_at
)
```

**è²¬ä»»ç¯„å›²ï¼š**
- âœ… ã‚¿ã‚¹ã‚¯ä½œæˆãƒ»ç®¡ç†
- âœ… ã‚¢ã‚µã‚¤ãƒ³ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
- âœ… ã‚³ãƒ¡ãƒ³ãƒˆãƒ»æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«
- âœ… å±¥æ­´ãƒ»ãƒ©ãƒ™ãƒ«ç®¡ç†

### 3. **winyx_memï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†å°‚ç”¨ï¼‰** ğŸ’¬
```sql
CREATE DATABASE winyx_mem;

-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«
channels (
    id, name, type, description, is_private, 
    created_by, created_at, updated_at
)

channel_participants (
    id, channel_id, user_id, role, joined_at, 
    last_read_at
)

messages (
    id, channel_id, user_id, content, message_type,
    reply_to_message_id, created_at, updated_at, deleted_at
)

message_attachments (
    id, message_id, file_name, file_path, file_size,
    mime_type, created_at
)

message_reactions (
    id, message_id, user_id, reaction_type, created_at
)

message_read_status (
    id, message_id, user_id, read_at
)

threads (
    id, parent_message_id, created_at, updated_at
)
```

**è²¬ä»»ç¯„å›²ï¼š**
- âœ… ãƒãƒ£ãƒ³ãƒãƒ«ç®¡ç†
- âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°
- âœ… ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰
- âœ… ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»æ—¢èª­ç®¡ç†

---

## ğŸ”„ ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: **Database per Service**
```mermaid
graph TB
    A[UserService] --> B[winyx_core]
    C[TaskService] --> D[winyx_task]
    E[MessageService] --> F[winyx_mem]
    
    C -.->|user_idå‚ç…§| B
    E -.->|user_idå‚ç…§| B
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: **Cross-Service API Call**
```typescript
// TaskServiceã‹ã‚‰UserServiceã®APIå‘¼ã³å‡ºã—
class TaskService {
  async getTaskWithUserInfo(taskId: string) {
    const task = await this.taskRepository.findById(taskId);
    
    // UserServiceã®APIã‚’å‘¼ã³å‡ºã—
    const user = await this.userServiceClient.getUserById(task.user_id);
    
    return {
      ...task,
      user: user
    };
  }
}
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: **Event-Driven ãƒ‡ãƒ¼ã‚¿åŒæœŸ**
```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
class UserService {
  async updateUser(userId: string, data: UpdateUserData) {
    await this.userRepository.update(userId, data);
    
    // ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã«é€šçŸ¥
    await this.eventBus.publish('user.updated', {
      userId,
      name: data.name,
      email: data.email
    });
  }
}

// TaskServiceã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å¤‰æ›´ã‚’å—ä¿¡
class TaskService {
  @EventHandler('user.updated')
  async handleUserUpdated(event: UserUpdatedEvent) {
    // å¿…è¦ã«å¿œã˜ã¦ã‚¿ã‚¹ã‚¯ã®æ‹…å½“è€…æƒ…å ±ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
    await this.updateUserCacheInfo(event.userId, event);
  }
}
```

---

## ğŸ“‹ å®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

### 1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šè¨­å®š**

#### UserService (winyx_coreæ¥ç¶š)
```yaml
# user_service/etc/user_service-api.yaml
Mysql:
  DataSource: "winyx_app:PASSWORD@tcp(127.0.0.1:3306)/winyx_core?charset=utf8mb4&parseTime=true"
```

#### TaskService (winyx_taskæ¥ç¶š)
```yaml  
# task_service/etc/task_service-api.yaml
Mysql:
  DataSource: "winyx_app:PASSWORD@tcp(127.0.0.1:3306)/winyx_task?charset=utf8mb4&parseTime=true"
```

#### MessageService (winyx_memæ¥ç¶š)
```yaml
# message_service/etc/message_service-api.yaml  
Mysql:
  DataSource: "winyx_app:PASSWORD@tcp(127.0.0.1:3306)/winyx_mem?charset=utf8mb4&parseTime=true"
```

### 2. **Cross-Serviceé€šä¿¡**

#### API Clientè¨­å®š
```go
// internal/clients/userserviceclient.go
type UserServiceClient struct {
    baseURL string
    client  *http.Client
}

func NewUserServiceClient(baseURL string) *UserServiceClient {
    return &UserServiceClient{
        baseURL: baseURL,
        client:  &http.Client{Timeout: 10 * time.Second},
    }
}

func (c *UserServiceClient) GetUser(ctx context.Context, userID int64) (*User, error) {
    url := fmt.Sprintf("%s/api/v1/users/%d", c.baseURL, userID)
    
    req, err := http.NewRequestWithContext(ctx, "GET", url, nil)
    if err != nil {
        return nil, err
    }
    
    resp, err := c.client.Do(req)
    if err != nil {
        return nil, err
    }
    defer resp.Body.Close()
    
    var user User
    if err := json.NewDecoder(resp.Body).Decode(&user); err != nil {
        return nil, err
    }
    
    return &user, nil
}
```

### 3. **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ä¿è¨¼**

#### Saga ãƒ‘ã‚¿ãƒ¼ãƒ³å®Ÿè£…ä¾‹
```go
// ã‚¿ã‚¹ã‚¯ä½œæˆæ™‚ã®Sagaãƒ‘ã‚¿ãƒ¼ãƒ³
type CreateTaskSaga struct {
    userService UserServiceClient
    taskRepo    TaskRepository
}

func (s *CreateTaskSaga) Execute(ctx context.Context, req CreateTaskRequest) error {
    // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å­˜åœ¨ç¢ºèª
    user, err := s.userService.GetUser(ctx, req.UserID)
    if err != nil {
        return fmt.Errorf("user validation failed: %w", err)
    }
    
    // 2. ã‚¿ã‚¹ã‚¯ä½œæˆ
    task, err := s.taskRepo.Create(ctx, &Task{
        UserID:      req.UserID,
        Title:       req.Title,
        Description: req.Description,
        Status:      "todo",
    })
    if err != nil {
        return fmt.Errorf("task creation failed: %w", err)
    }
    
    // 3. æˆåŠŸé€šçŸ¥ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œï¼‰
    s.eventBus.Publish("task.created", TaskCreatedEvent{
        TaskID: task.ID,
        UserID: user.ID,
        Title:  task.Title,
    })
    
    return nil
}
```

---

## ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

### 1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
- âœ… ã‚µãƒ¼ãƒ“ã‚¹æ¯ã«å°‚ç”¨ã®DBãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
- âœ… æœ€å°æ¨©é™ã®åŸå‰‡ï¼ˆå¿…è¦ãªãƒ†ãƒ¼ãƒ–ãƒ«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ï¼‰
- âœ… æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®æœ€é©åŒ–

### 2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**
- âœ… ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
- âœ… N+1å•é¡Œã®å›é¿
- âœ… ãƒãƒƒãƒå‡¦ç†ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿åŒæœŸ

### 3. **ç›£è¦–ãƒ»ãƒ­ã‚®ãƒ³ã‚°**
```go
// åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ç”¨ãƒ­ã‚°
logx.Infow("Cross-service call",
    logx.Field("service", "TaskService"),
    logx.Field("target", "UserService"),
    logx.Field("user_id", userID),
    logx.Field("trace_id", traceID),
)
```

---

## ğŸš€ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥

### ãƒ•ã‚§ãƒ¼ã‚º1: åŸºç›¤æº–å‚™
1. æ—¢å­˜ã®`winyx_core`ã«æ¨©é™ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ 
2. UserServiceã§æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ´»ç”¨

### ãƒ•ã‚§ãƒ¼ã‚º2: æ–°ã‚µãƒ¼ãƒ“ã‚¹è¿½åŠ   
1. `winyx_task`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ
2. TaskServiceã®å®Ÿè£…ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤

### ãƒ•ã‚§ãƒ¼ã‚º3: çµ±åˆãƒ»æœ€é©åŒ–
1. `winyx_mem`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ  
2. MessageServiceã®å®Ÿè£…ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
3. ã‚µãƒ¼ãƒ“ã‚¹é–“é€£æºã®æœ€é©åŒ–

---

## ğŸ“ ã¾ã¨ã‚

### âœ… **æ¡ç”¨ã™ã‚‹è¨­è¨ˆ**
- **Database per Service** - å„ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãŒç‹¬è‡ªã®DBã‚’æŒã¤
- **æ—¢å­˜winyx_coreã®æ´»ç”¨** - èªè¨¼åŸºç›¤ã¨ã—ã¦å…±é€šåˆ©ç”¨
- **API-basedé€šä¿¡** - ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹
- **ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•** - ãƒ‡ãƒ¼ã‚¿åŒæœŸã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°

### ğŸ¯ **æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ**
- ğŸ”§ **é–‹ç™ºç‹¬ç«‹æ€§** - å„ãƒãƒ¼ãƒ ãŒç‹¬ç«‹ã—ã¦é–‹ç™ºå¯èƒ½
- ğŸ“ˆ **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£** - ã‚µãƒ¼ãƒ“ã‚¹æ¯ã®å€‹åˆ¥ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
- ğŸ›¡ï¸ **éšœå®³åˆ†é›¢** - ä¸€éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®éšœå®³ãŒå…¨ä½“ã«å½±éŸ¿ã—ãªã„
- ğŸš€ **æŠ€è¡“é¸æŠã®è‡ªç”±** - ã‚µãƒ¼ãƒ“ã‚¹æ¯ã«æœ€é©ãªæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã‚’é¸æŠ

ã“ã®è¨­è¨ˆã«ã‚ˆã‚Šã€Winyxãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯å …ç‰¢ã§æ‹¡å¼µæ€§ã®é«˜ã„ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚